[platformio]
default_envs = esp32

[env]
# Global library dependency finder settings
lib_ldf_mode = deep+
lib_compat_mode = strict
lib_deps =
    knolleary/PubSubClient@^2.8
    bblanchon/ArduinoJson@^6.21
    adafruit/Adafruit BME280 Library@^2.2.2
    adafruit/Adafruit Unified Sensor@^1.1.14

; Native environment for unit testing (runs on host machine)
[env:native]
platform = native
build_flags =
    -std=gnu++17
    -DUNIT_TEST
    -DARDUINO=200
    -fprofile-arcs
    -ftest-coverage
    -Itest/mocks
extra_scripts = pre:scripts/native_coverage.py
test_framework = unity
test_ignore = test_integration

; Static analysis environment (for clang-tidy)
[env:analysis]
platform = native
build_flags =
    -std=gnu++17
    -DUNIT_TEST
    -DARDUINO=200
    -Itest/mocks
    ; Local library include paths for clang-tidy
    -Ilib/WiFiManager
    -Ilib/BME280Sensor
    -Ilib/CertificateManager/include
    -Ilib/CertificateManager/src
    -Ilib/MqttClient
    -Ilib/PowerManager
    -Ilib/TimeManager
    ; External library include paths
    -I.pio/libdeps/analysis/PubSubClient/src
    -I.pio/libdeps/analysis/ArduinoJson/src
    "-I.pio/libdeps/analysis/Adafruit BME280 Library"
    "-I.pio/libdeps/analysis/Adafruit Unified Sensor"
    "-I.pio/libdeps/analysis/Adafruit BusIO"

; ESP32 environment for integration testing (runs on device)
[env:esp32]
platform = espressif32
board = seeed_xiao_esp32c3
framework = arduino
build_flags =
    -DMBEDTLS_X509_CRT_PARSE_C
    -DMBEDTLS_PEM_PARSE_C
test_framework = unity
test_ignore = test_native
upload_speed = 921600
monitor_speed = 115200

; For running tests on actual hardware
test_port = /dev/ttyACM0
test_speed = 115200
